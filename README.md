## i2ecws-lib@2.1.0

### Building

Starting from the very beginning, the only dependencies here are: 
* ```swagger.json``` - this is the API specification generated by the build process. We can also point to a URL.
* ```swagger-codegen-cli.jar (2.4.18)``` - the command-line code generation tool 
* ```config.json``` - this file contains common settings for the generation process 
* ```build-api.cmd``` - a batch file to run the code generation tool with all the proper settings. Examine this file for additional information.
* ```package.mustache``` and ```ng-package.mustache``` in ```templates\typescript-angular``` - these are the mustache template files to generate package.json and ng-package.json.

#### swagger.json

This file contains the api definition. Any time the API changes, this file should be updated and the process run again. As noted above, this can be a URL instead of a file.

#### swagger-codegen-cli.jar

This is the swagger code generation tool. We should be using the same version that was used by the maven plugin to generate 
the swagger.json file above, although it's probably not strictly necessary, as long as both versions support the same
version of the OpenAPI spec. Kept in the /bin folder.

You can get it from the NCI Nexus repository here:
```https://ncimvn.nci.nih.gov/nexus/service/local/repositories/central/content/io/swagger/swagger-codegen-cli/2.4.18/swagger-codegen-cli-2.4.18.jar```


#### config.json

This file has some configuration settings that are necessary to configure the build properly. These are the same 
settings that are passed to the swagger codegen maven plugin, so whenever those values are updated, these values
should be updated as well.

Specifically:
* ngVersion - the version of angular to use. This will affect the values in package.json
* npmName - the name of the package we're building
* npmVersion - the version of the package we're building. This should synch with the version of the API.

Note that these values can also be passed in on the command line. There are examples in build-api.cmd below. Also note
that contrary to what you might expect, the values in the file will always override the values on the commandline.

#### build-api.cmd

This is just a simple batch file that executes the build and generates the angular API. It has been annotated to provide
more information about how it works if you need to customize it.

#### package.json and ng-package.json templates

Strictly speaking, there's no reason we need to use templates instead of just manually updating the files. For now, 
I left it this way because that's how the maven plugin does it. Just remember that if you change the generated versions,
they will get overwritten the next time you build the API. If you want permanent changes, update the template.

I should also note that in ```package.mustache```, you can see the directive ```#useNgPackagr``` this property is set
automatically when ngVersion (in ```config.json``) is > 4.0.0.

**NOTE:** the generated versions of package.json and ng-package.json go in the output directory specified in the 
build-api.cmd script above. There is no need for either file in the root of the project. 

### Logging in to the NPM package repository

#### .npmrc

You can create a file named .npmrc in the directory you wish to publish from. This file includes information about
the NPM registry you want to publish to. It should look like this:

```
registry=https://npm.pkg.github.com/NCI-CBIIT
//npm.pkg.github.com/:_authToken=<insert your token here>
```

Obviously, you will need to create a token with the appropriate permissions first.

#### Log in from the command line
Alternatively, you can log in to the package registry from the command line.
```
npm login --scope=@NCI-CBIIT --registry=https://npm.pkg.github.com

> Username: USERNAME
> Password: TOKEN
> Email: PUBLIC-EMAIL-ADDRESS
```

To build the API:
```
execute the build-api.cmd script

```
Change directory into the output directory you specified in the build script and run: 
```
npm install
```

Then:

```
npm run build
```

Then:

```
npm publish
```

*Note*: if you haven't logged in to the npm package registry, and don't have a properly configured .npmrc, you
will get an error here.

There is one additional step if you want to create a tarball for manual distribution. Change into the ```dist``` folder, 
and run:

```
npm pack

if all goes well, you should now have a file called <npmName>-<npmVersion>.tgz in the dist folder. You can copy that
file into a client project and reference it in package.json with:

"i2ecws-lib":"file:<npmName>-<npmVersion>.tgz"
```

#### Other useful things to know

In addition to setting the version with the npmVerion property, it's possible to set it with the following command:

```
npm version <X.X.X>
```

This will override any other values and write it back to package.json. This will be primarily useful for promoting a
package to release status.


#### Open Questions and Issues

* We've had complaints about publishing packages compiled with ivy in the past, but there is no setting specifically
disabling it here.  Not sure why this works...
* The angular.json file in the project root doesn't seem to do anything and may not be necessary.
* The project was configured as an angular library project (hence angular.json), but that doesn't seem to be strictly
necessary either.
* I'm pretty sure that if we had a package.json in the root of the project with the proper dependencies, we could use
  ```ng build i2ecws-lib``` to build the project. I need to investigate and confirm that.

#### General usage

In your Angular project:


```
// without configuring providers
import { ApiModule } from 'i2ecws-lib';
import { HttpClientModule } from '@angular/common/http';


@NgModule({
  imports: [
    ApiModule,
    // make sure to import the HttpClientModule in the AppModule only,
    // see https://github.com/angular/angular/issues/20575
    HttpClientModule
  ],
  declarations: [ AppComponent ],
  providers: [],
  bootstrap: [ AppComponent ]
})
export class AppModule {}
```

```
// configuring providers
import { ApiModule, Configuration, ConfigurationParameters } from 'i2ecws-lib';

export function apiConfigFactory (): Configuration => {
 const params: ConfigurationParameters = {
  // set configuration parameters here.
 }
 return new Configuration(params);
}

@NgModule({
  imports: [ ApiModule.forRoot(apiConfigFactory) ],
  declarations: [ AppComponent ],
  providers: [],
  bootstrap: [ AppComponent ]
})
export class AppModule {}
```

```
import { DefaultApi } from 'i2ecws-lib';

export class AppComponent {
	 constructor(private apiGateway: DefaultApi) { }
}
```

Note: The ApiModule is restricted to being instantiated once app wide.
This is to ensure that all services are treated as singletons.

#### Using multiple swagger files / APIs / ApiModules
In order to use multiple `ApiModules` generated from different swagger files,
you can create an alias name when importing the modules
in order to avoid naming conflicts:
```
import { ApiModule } from 'my-api-path';
import { ApiModule as OtherApiModule } from 'my-other-api-path';
import { HttpClientModule } from '@angular/common/http';


@NgModule({
 imports: [
  ApiModule,
   OtherApiModule,
    // make sure to import the HttpClientModule in the AppModule only,
    // see https://github.com/angular/angular/issues/20575
    HttpClientModule
  ]
})
export class AppModule {

}
```


### Set service base path
If different than the generated base path, during app bootstrap, you can provide the base path to your service. 

```
import { BASE_PATH } from 'i2ecws-lib';

bootstrap(AppComponent, [
    { provide: BASE_PATH, useValue: 'https://your-web-service.com' },
]);
```
or

```
import { BASE_PATH } from 'i2ecws-lib';

@NgModule({
    imports: [],
    declarations: [ AppComponent ],
    providers: [ provide: BASE_PATH, useValue: 'https://your-web-service.com' ],
    bootstrap: [ AppComponent ]
})
export class AppModule {}
```


#### Using @angular/cli
First extend your `src/environments/*.ts` files by adding the corresponding base path:

```
export const environment = {
  production: false,
  API_BASE_PATH: 'http://127.0.0.1:8080'
};
```

In the src/app/app.module.ts:
```
import { BASE_PATH } from 'i2ecws-lib';
import { environment } from '../environments/environment';

@NgModule({
  declarations: [
    AppComponent
  ],
  imports: [ ],
  providers: [{ provide: BASE_PATH, useValue: environment.API_BASE_PATH }],
  bootstrap: [ AppComponent ]
})
export class AppModule { }
```  
